#!/usr/bin/env python
from hackeriet import mifare
from hackeriet.mqtt import MQTT
from hackeriet.door import Doors, users
import uuid, time, sys, os, logging

piface = False
if "PIFACE" in os.environ: piface = True
pin = int(os.getenv("DOOR_PIN", 5))
timeout = int(os.getenv("DOOR_TIMEOUT", 1))

#logging.basicConfig(filename='/opt/nfcd/nfcd.log', level=logging.INFO, format='%(asctime)-15s %(message)s')
logging.basicConfig(level=logging.INFO, format='%(asctime)-15s %(message)s')

door = Doors(piface=piface,pin=pin,timeout=timeout)

mqtt = MQTT()

while True:
  users.load()
  data = mifare.try_read()
  if data:
    user = users.auth(data[0:16])
    if not user == None:
      sys.stderr.write(user + " opened the door\n")
      sys.stderr.flush()
      logging.error(user.encode('ascii', 'replace').decode('ascii') + " opened the door")
      door.open()
      mqtt("hackeriet/door/hackeriet/open", user)

