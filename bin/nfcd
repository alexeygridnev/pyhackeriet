#!/usr/bin/env python

import config
from hackeriet import mifare
from hackeriet.door import Doors, users
import uuid, time, sys, os, logging

if hasattr(config, "keyA"): mifare.keyA = config.keyA
if hasattr(config, "keyB"): mifare.keyB = config.keyB
if not hasattr(config, "piface"): config.piface = False
if not hasattr(config, "pin"): config.pin = 5
if not hasattr(config, "timeout"): config.timeout = 1

logging.basicConfig(filename='/opt/nfcd/nfcd.log', level=logging.INFO, format='%(asctime)-15s %(message)s')
door = Doors(piface=config.piface,pin=config.pin,timeout=config.timeout)
users.load()

while True:
  data = mifare.try_read()
  if data:
    user = users.auth(data[0:16])
    if not user == None:
      sys.stderr.write(user + " opened the door\n")
      sys.stderr.flush()
      logging.error(user.encode('ascii', 'replace').decode('ascii') + " opened the door")
      door.open()

